@page "/admin/hospitals"
<PageTitle>Hospital Lists - QueueSpot</PageTitle>

@layout AdminLayout
@using BlazorBootstrap
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using app.Models
@using Microsoft.EntityFrameworkCore
@inject NavigationManager Nav
@inject ApplicationDbContext dbContext
@inject ProtectedSessionStorage Session

<h1 class="ms-5">Hospital Management</h1>

<span class="float-end"><button class="btn btn-primary me-5" type="button" @onclick="RegisterNewHospital"> Create New
    Hospital</button></span>

    <div class="admin-container">
        <div class="tile">
            <div class="tile-container">
                <div class="float-end d-flex align-items-center gap-2" style="margin-bottom:10px;">
                    <TextInput @bind-Value="@searchText" Placeholder="Enter Hospital Name" @onkeyup="OnSearchBarDown" />
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                            @sortLabel
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><button class="dropdown-item" type="button"
                                            @onclick="() => OnSortChanged(SortOption.Newest)">Newest first</button></li>
                                <li><button class="dropdown-item" type="button"
                                                @onclick="() => OnSortChanged(SortOption.Oldest)">Oldest first</button></li>
                                    <li><button class="dropdown-item" type="button"
                                                    @onclick="() => OnSortChanged(SortOption.NameAsc)">Name A–Z</button></li>
                                        <li><button class="dropdown-item" type="button"
                                                        @onclick="() => OnSortChanged(SortOption.NameDesc)">Name Z–A</button></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="clearfix"></div>
                                <HospitalMgmtList Hospitals="hospitals"></HospitalMgmtList>

                                <div class=" mt-4 d-flex justify-content-center align-items-center">
                                    <Pagination TotalPages="@TotalPages" ActivePageNumber="@ActivePageNumber"
                                                PageChanged="OnPageChangedAsync" />
                                </div>
                            </div>
                        </div>
                    </div>

@code {
    int ActivePageNumber = 1;
    int TotalPages = 1;
    string searchText = "";
    List<Hospital> hospitals = new List<Hospital>();
    SortOption sortOption = SortOption.Newest;
    string sortLabel = "Newest first";

    protected override void OnInitialized()
    {
        UpdatePages();
        LoadPage(ActivePageNumber);

    }

    public async Task OnSearchBarDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HospitalSearch();
        }
    }

    public async Task OnPageChangedAsync(int newPageNumber)
    {
        ActivePageNumber = newPageNumber;
        LoadPage(newPageNumber);
    }

    private void LoadPage(int page)
    {
        hospitals.Clear();
        var query = dbContext.Hospitals
            .Where(h => EF.Functions.Like(h.Name, $"%{searchText}%"));

        query = sortOption switch
        {
            SortOption.Oldest => query.OrderBy(h => h.Id),
            SortOption.NameAsc => query.OrderBy(h => h.Name),
            SortOption.NameDesc => query.OrderByDescending(h => h.Name),
            _ => query.OrderByDescending(h => h.Id)
        };

        hospitals = query
            .Skip((page - 1) * 10)
            .Take(10)
            .ToList();

        /*for (int i = (page - 1) * 10; i < (page * 10) + 10; i++)
        {
        hospitals.Add(new Hospital()
        {
        Id = i,
        Name = "No name hospital " + i.ToString(),
        Photo = "/images/hospital_pic_example.jpg",
        Address = "555 Avenue Rd, Toronto, ON",
        Status = ""
        });
        }*/
    }

    private void RegisterNewHospital()
    {
        Nav.NavigateTo("/admin/hospitals/edit");
    }

    private void UpdatePages()
    {
        int TotalArticles = dbContext.Hospitals.Where(h => EF.Functions.Like(h.Name, $"%{searchText}%")).Count<Hospital>();
        Console.WriteLine("TotalArticles : {0}", TotalArticles);
        TotalPages = (int)Math.Ceiling((double)TotalArticles / 10.0);
        Console.WriteLine("TotalPages : {0}", TotalPages);
    }

    private async Task HospitalSearch()
    {
        UpdatePages();
        LoadPage(ActivePageNumber);
    }

    private void OnSortChanged(SortOption option)
    {
        sortOption = option;
        sortLabel = option switch
        {
            SortOption.Oldest => "Oldest first",
            SortOption.NameAsc => "Name A–Z",
            SortOption.NameDesc => "Name Z–A",
            _ => "Newest first"
        };

        LoadPage(ActivePageNumber);
    }

    private enum SortOption
    {
        Newest,
        Oldest,
        NameAsc,
        NameDesc
    }
}