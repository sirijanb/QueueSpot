@page "/admin/hospitals"
<PageTitle>Hospital Lists - QueueSpot</PageTitle>

@layout AdminLayout
@using BlazorBootstrap
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using app.Models
@using Microsoft.EntityFrameworkCore
@inject NavigationManager Nav
@inject ApplicationDbContext dbContext
@inject ProtectedSessionStorage Session

<h1>Hospital Management</h1>

<span class="float-end"><button class="btn btn-primary" type="button" @onclick="RegisterNewHospital">New
        Hospital</button></span>

<div class="admin-container">
    <div class="tile">
        <div class="tile-container">

            <div class="float-end " style="margin-bottom:10px;">
                <TextInput @bind-Value="@searchText" Placeholder="Enter text" @onkeyup="OnSearchBarDown" />
            </div>
            <div class="clearfix"></div>
            <HospitalMgmtList Hospitals="hospitals"></HospitalMgmtList>

            <Pagination TotalPages="@TotalPages" ActivePageNumber="@ActivePageNumber"
                PageChanged="OnPageChangedAsync" />
        </div>
    </div>
</div>

@code {
    int ActivePageNumber = 1;
    int TotalPages = 1;
    string searchText = "";
    List<Hospital> hospitals = new List<Hospital>();

    protected override void OnInitialized()
    {
        UpdatePages();
        LoadPage(ActivePageNumber);

    }

    public async Task OnSearchBarDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HospitalSearch();
        }
    }

    public async Task OnPageChangedAsync(int newPageNumber)
    {
        ActivePageNumber = newPageNumber;
        LoadPage(newPageNumber);
    }

    private void LoadPage(int page)
    {
        hospitals.Clear();
        hospitals = dbContext.Hospitals
        .Where(h => EF.Functions.Like(h.Name, $"%{searchText}%"))
        .OrderBy(h => h.Id)
        .Skip((page - 1) * 10)
        .Take(10)
        .ToList();

        /*for (int i = (page - 1) * 10; i < (page * 10) + 10; i++)
        {
        hospitals.Add(new Hospital()
        {
        Id = i,
        Name = "No name hospital " + i.ToString(),
        Photo = "/images/hospital_pic_example.jpg",
        Address = "555 Avenue Rd, Toronto, ON",
        Status = ""
        });
        }*/
    }

    private void RegisterNewHospital()
    {
        Nav.NavigateTo("/admin/hospitals/edit");
    }

    private void UpdatePages()
    {
        int TotalArticles = dbContext.Hospitals.Where(h => EF.Functions.Like(h.Name, $"%{searchText}%")).Count<Hospital>();
        Console.WriteLine("TotalArticles : {0}", TotalArticles);
        TotalPages = (int)Math.Ceiling((double)TotalArticles / 10.0);
        Console.WriteLine("TotalPages : {0}", TotalPages);
    }

    private async Task HospitalSearch()
    {
        UpdatePages();
        LoadPage(ActivePageNumber);
    }
}