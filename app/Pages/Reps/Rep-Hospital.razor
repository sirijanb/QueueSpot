@page "/rep/hospital"
<PageTitle>Representative Hospital Edit | QueueSpot</PageTitle>
@layout RepLayout
@using BlazorBootstrap
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.EntityFrameworkCore
@using app.Models
@inject NavigationManager Nav
@inject ProtectedSessionStorage Session
@inject ApplicationDbContext dbContext
@inject IJSRuntime JS

<h1 class="ms-5">Hospital Edit</h1>

<ConfirmDialog @ref="dialog" />

<div class="admin-container">
    <div class="tile">
        <div class="tile-container">
            <form class="w-80">
                <div class="row mb-4">
                    <div class="col-1">
                        <img src="@HospitalImage" class="rounded-circle"
                             style="width: 110px; height: 110px; object-fit: cover; display: block;"
                             alt="Hospital Image">
                    </div>

                    <div class="col-8 d-flex flex-column justify-content-center">
                        <h2>@hospital.Name</h2>
                        <span>@hospital.Address</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="mb-3">
                            <label>Beds Available</label>
                            <input type="text" class="form-control w-100" @bind-value="hospital.BedsOpen" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                   placeholder="Enter Beds Available" />
                        </div>
                    </div>
                    <div class="col">
                        <div class="mb-3">
                            <label>Status</label>
                            <input type="text" class="form-control w-100" @bind-value="hospital.Status"
                                   placeholder="Enter Status" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="mb-3">
                            <label>Estimated Wait Time (Min)</label>
                            <input type="text" class="form-control w-100" @bind-value="hospital.EstimatedWait" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                   placeholder="Enter Estimated Wait Time" />
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button class="btn btn-success" style="width: 180px;" type="button"
                            @onclick="OnClickSave">Update</button>
                </div>

                @if (SuccessfulUpdate)
                {
                    <div class="alert alert-success mt-3" role="alert">
                        Your Hospital Information has been updated.
                    </div>
                }

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger mt-3" role="alert">
                        @errorMessage
                    </div>
                }

            </form>
        </div>
    </div>
</div>

@code {
    private ConfirmDialog dialog = default!;
    private Hospital hospital = new Hospital();
    private Representative representative = new Representative();

    private bool SuccessfulUpdate = false;
    private string HospitalImage = "/images/hospital_pic_example_grey.jpg";
    private string errorMessage = "";


    protected override void OnInitialized()
    {

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

            var currentSess = await Session.GetAsync<string>("email");
            string? currentEmail = currentSess.Value;
            if (currentEmail != null)
            {
                Console.WriteLine("Hospital info from : {0}", currentEmail);
                representative = dbContext.Representative.Where(r => r.Email ==
currentEmail).Include<Representative>("Hospital").First<Representative>();
                hospital = representative.Hospital;
                if (!string.IsNullOrEmpty(hospital.Photo))
                {
                    HospitalImage = hospital.Photo;
                }
                Console.WriteLine("Reps hospital : {0}", hospital.Name);
                StateHasChanged();
            }
            else
            {
                Console.WriteLine("Current email is null");
            }
        }
    }

    private async Task OnClickSave()
    {
        errorMessage = "";
        SuccessfulUpdate = false;

        if (string.IsNullOrWhiteSpace(hospital.BedsOpen))
        {
            errorMessage = "Beds Available is required.";
            return;
        }

        if (!IsWholeNumber(hospital.BedsOpen))
        {
            errorMessage = "Beds Available must be a whole number.";
            return;
        }

        if (string.IsNullOrWhiteSpace(hospital.Status))
        {
            errorMessage = "Status is required.";
            return;
        }

        if (!IsStatusText(hospital.Status))
        {
            errorMessage = "Status must contain only letters and spaces.";
            return;
        }

        if (string.IsNullOrWhiteSpace(hospital.EstimatedWait))
        {
            errorMessage = "Estimated Wait Time is required.";
            return;
        }

        if (!IsWholeNumber(hospital.EstimatedWait))
        {
            errorMessage = "Estimated Wait Time must be a whole number.";
            return;
        }


        await JS.InvokeVoidAsync("sendHospitalUpdateInfo", hospital.PlaceID, hospital.EstimatedWait, hospital.BedsOpen);
        dbContext.Hospitals.Update(hospital);


        dbContext.SaveChanges();
        SuccessfulUpdate = true;
        //Nav.NavigateTo("/rep/hospital");
    }

    private bool IsWholeNumber(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return false;
        }

        return int.TryParse(value.Trim(), out _);
    }

    private bool IsStatusText(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return false;
        }

        var pattern = @"^[A-Za-z ]+$";
        return System.Text.RegularExpressions.Regex.IsMatch(value.Trim(), pattern);
    }

}